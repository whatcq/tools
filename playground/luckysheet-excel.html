<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <title>Luckysheet-excel</title>

    <!-- å¼•å…¥luckysheetï¼Œç”¨äºæ¸²æŸ“è¡¨æ ¼ -->
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css'/>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <!-- å¼•å…¥exceljsã€FileSaverï¼Œç”¨äºluckysheetè¡¨æ ¼è½¬xlsxæ–‡ä»¶ -->
    <script src="http://localhost/cqiu/tools/static/cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.bootcdn.net/ajax/libs/exceljs/4.3.0/exceljs.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>
    <script>
        $(function () {
            //Configuration item
            var options = {
                container: 'luckysheet', //luckysheet is the container id
                showinfobar: false,
                title: 'åœ¨çº¿è¡¨æ ¼', // è®¾å®šè¡¨æ ¼åç§°
                lang: 'zh' // è®¾å®šè¡¨æ ¼è¯­è¨€
            }
            luckysheet.create(options)
        });
    </script>
    <style>
        .overwrite {
            color: red
        }
    </style>
</head>

<body>
<div id="lucky-mask-demo"
     style="position: absolute;z-index: 1000000;left: 0px;top: 0px;bottom: 0px;right: 0px; background: rgba(255, 255, 255, 0.8); text-align: center;font-size: 40px;align-items:center;justify-content: center;display: none;">
    download...
</div>
<div id="luckysheet"
     style="margin:0px;padding:0px;position:absolute;width:100%;left: 0px;top: 0;bottom: 0px;outline: none;">
</div>
<div style="z-index: 0;position: fixed; left: 0; bottom: 0;max-width: 50%;width: 380px; line-height: 20px;height: 20px;display: flex;">
    <label onclick="" style="display: flex" title="ä¸å˜åˆ™ä¸ä¼šé‡æ–°åŠ è½½">ğŸ“‚
        <input style="font-size:16px;display:none" type="file" id="select-file" name="select-file"/>
    </label>
    <input type="text" name="filename" id="filename" list="files" value="" title="å½“å¿ƒä¸¢å¤±orè¦†ç›–">
    <datalist id="files"></datalist>

    <!--æˆ–åŠ è½½è¿œç¨‹ xlsx æ–‡ä»¶ï¼š
    <select style="height: 27px;top: -2px;position: relative;" id="Luckyexcel-select-demo">
        <option value="">é€‰æ‹©ç½‘ç»œæ–‡ä»¶</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/money-manager-2.xlsx">Money Manager.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Activity%20costs%20tracker.xlsx">Activity costs tracker.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/House%20cleaning%20checklist.xlsx">House cleaning checklist.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Student%20assignment%20planner.xlsx">Student assignment planner.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Credit%20card%20tracker.xlsx">Credit card tracker.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Blue%20timesheet.xlsx">Blue timesheet.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Student%20calendar%20%28Mon%29.xlsx">Student calendar (Mon).xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Blue%20mileage%20and%20expense%20report.xlsx">Blue mileage and expense report.xlsx</option>
    </select>-->
    <a style="cursor: pointer;padding:0;border:none" id="downlod-file" title="ä¸‹è½½">â¬</a>
    <a style="cursor: pointer;padding:0;border:none" id="save-file" title="ä¿å­˜åˆ°æœåŠ¡å™¨">â«</a>
    <!--  ğŸ’¾ åŠ äº†ä¸‹é¢è¿™è¡Œï¼Œä¸Šé¢çš„datalistæ‰æ˜¾ç¤ºå¼¹å‡ºæ¡†ï¼Œå¥‡æ€ªé—®é¢˜ -->
    <input type="text" list="files2" name="filename2" id="filename2" style="display:none">
    <datalist id="files2">
        <option value="Option1">
    </datalist>
    <span id="msg" style="font-size:12px"></span>
</div>

<script>
    let ext = 'xlsx';
    let uploadUrl = './saver.php?act=upload';
    let fullName = 'Excel-1'; // æ­£åœ¨ç¼–è¾‘çš„Excelæ–‡ä»¶åï¼ŒåŒ…å«åç¼€å
    function notice(msg) {
        let div = document.getElementById("msg");
        div.innerHTML = msg;
        setTimeout(function () {
            div.style.opacity = 0.5;
            setTimeout(function () {
                div.style.opacity = 1;
                div.innerHTML = "";
            }, 1000);
        }, 2000);
    }

    function starter() {
        let filename = document.getElementById("filename");
        let selectBtn = document.getElementById("select-file");
        // let selectADemo = document.getElementById("Luckyexcel-select-demo");
        let downloadBtn = document.getElementById("downlod-file");
        let uploadBtn = document.getElementById("save-file");
        let mask = document.getElementById("lucky-mask-demo");

        window.onload = () => {
            filename.addEventListener('change', function () {
                fullName = filename.value;
                document.title = filename.value;
                console.log('changed!', filename.value);
            });
            // filename.value = fullName;
            // filename.dispatchEvent(new Event('change'));
            // åŠ è½½è¿œç¨‹æ–‡ä»¶s
            filename.onfocus = function () {
                this.select();
                document.getElementById('files').style.display = "block";
                if (filename.list.options.length > 0) return true;
                fetch('saver.php?act=files&ext=' + ext)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        data.forEach(function (item) {
                            let option = document.createElement('option');
                            option.value = item;
                            filename.list.appendChild(option);
                        });
                    });
            };
            filename.addEventListener('input', function () {
                console.log('remove class overwrite')
                filename.classList.remove('overwrite');
                // æ£€æŸ¥inputçš„å€¼æ˜¯å¦åœ¨datalistçš„é€‰é¡¹ä¸­
                var found = Array.prototype.some.call(filename.list.options, function (option) {
                    return option.value === filename.value;
                });

                if (found) {
                    // åŠ è½½è¿œç¨‹æ–‡ä»¶
                    loadRemoteExcel(filename.value + '.' + ext, filename.value);

                }
            });

            selectBtn.addEventListener("change", function (evt) {
                var files = evt.target.files;
                if (files == null || files.length == 0) {
                    alert("No files wait for import");
                    return;
                }

                let name = files[0].name;
                let suffixArr = name.split("."), suffix = suffixArr[suffixArr.length - 1];
                if (suffix != ext) {
                    alert("Currently only supports the import of xlsx files");
                    return;
                }
                suffixArr.pop();
                name = suffixArr.join(".");
                var found = Array.prototype.some.call(filename.list.options, function (option) {
                    return option.value === name;
                });

                if (found) {
                    console.log('add class overwrite')
                    filename.classList.add('overwrite');
                }
                filename.value = name;
                filename.dispatchEvent(new Event('change'));
                LuckyExcel.transformExcelToLucky(files[0], function (exportJson, luckysheetfile) {

                    if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                        alert("Failed to read the content of the excel file, currently does not support xls files!");
                        return;
                    }
                    window.luckysheet.destroy();

                    window.luckysheet.create({
                        container: 'luckysheet', //luckysheet is the container id
                        showinfobar: false,
                        data: exportJson.sheets,
                        title: 'åœ¨çº¿è¡¨æ ¼',
                        userInfo: exportJson.info.name.creator,
                        lang: 'zh'
                    });
                });
            });

            var loadRemoteExcel = function (url, name) {
                if (!url) {
                    return;
                }
                mask.style.display = "flex";
                LuckyExcel.transformExcelToLuckyByUrl(url, name, function (exportJson, luckysheetfile) {
                    if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                        alert("Failed to read the content of the excel file, currently does not support xls files!");
                        return;
                    }
                    // console.log(exportJson, luckysheetfile);
                    mask.style.display = "none";
                    window.luckysheet.destroy();

                    window.luckysheet.create({
                        container: 'luckysheet', //luckysheet is the container id
                        showinfobar: false,
                        data: exportJson.sheets,
                        title: 'åœ¨çº¿è¡¨æ ¼',
                        userInfo: exportJson.info.name.creator,
                        lang: 'zh'
                    });
                });
            }

            /*selectADemo.addEventListener("change", function (evt) {
                var obj = selectADemo;
                var index = obj.selectedIndex;
                var value = obj.options[index].value;
                var name = obj.options[index].innerHTML;
                if (value == "") {
                    return;
                }
                filename.value = name;
                filename.dispatchEvent(new Event('change'));
                loadRemoteExcel(value, name);
            });*/

            uploadBtn.addEventListener("click", function (evt) {
                if (!filename.value) {
                    notice('è¯·è¾“å…¥æ–‡ä»¶å');
                    return;
                }
                uploadExcel(window.luckysheet.getAllSheets(), filename.value + '.' + ext)  // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            });

            downloadBtn.addEventListener("click", function (evt) {
                if (!filename.value) {
                    notice('è¯·è¾“å…¥æ–‡ä»¶å');
                    return;
                }
                exportExcelFront(window.luckysheet.getAllSheets(), filename.value + '.' + ext) // ä¸‹è½½Excel

                // var obj = selectADemo;
                // var index = obj.selectedIndex;
                // var value = obj.options[index].value;
                // if (value.length == 0) {
                //     alert("Please select a demo file");
                //     return;
                // }
                // var elemIF = document.getElementById("Lucky-download-frame");
                // if (elemIF == null) {
                //     elemIF = document.createElement("iframe");
                //     elemIF.style.display = "none";
                //     elemIF.id = "Lucky-download-frame";
                //     document.body.appendChild(elemIF);
                // }
                // elemIF.src = value;

            });
        }
    }
    starter();


    /**
     * ä¸Šä¼ åˆ°æœåŠ¡å™¨
     * @param luckysheet    -> luckysheetçš„æ‰€æœ‰sheet
     * @param name          -> ä¿å­˜æ–‡ä»¶åï¼ˆå¦‚ï¼ša.xlsxï¼‰
     * @param excelType     -> office/wps
     */
    var uploadExcel = function (luckysheet, name, excelType) {
        // 1.åˆ›å»ºå·¥ä½œç°¿ï¼Œå¯ä»¥ä¸ºå·¥ä½œç°¿æ·»åŠ å±æ€§
        const workbook = new ExcelJS.Workbook()
        // 2.åˆ›å»ºè¡¨æ ¼ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥é…ç½®åˆ›å»ºä»€ä¹ˆæ ·çš„å·¥ä½œè¡¨
        luckysheet.forEach(function (table) {
            // debugger
            if (table.data.length === 0) return true
            const worksheet = workbook.addWorksheet(table.name)
            const merge = (table.config && table.config.merge) || {}        //åˆå¹¶å•å…ƒæ ¼
            const borderInfo = (table.config && table.config.borderInfo) || {}      //è¾¹æ¡†
            const columnWidth = (table.config && table.config.columnlen) || {}    //åˆ—å®½
            const rowHeight = (table.config && table.config.rowlen) || {}      //è¡Œé«˜
            const frozen = table.frozen || {}       //å†»ç»“
            const rowhidden = (table.config && table.config.rowhidden) || {}    //è¡Œéšè—
            const colhidden = (table.config && table.config.colhidden) || {}    //åˆ—éšè—
            const filterSelect = table.filter_select || {}    //ç­›é€‰
            const images = table.images || {}   //å›¾ç‰‡
            // console.log(table)
            const hide = table.hide;    //å·¥ä½œè¡¨ sheet 1éšè—
            if (hide === 1) {
                // éšè—å·¥ä½œè¡¨
                worksheet.state = 'hidden';
            }
            setStyleAndValue(table.data, worksheet)
            setMerge(merge, worksheet)
            setBorder(borderInfo, worksheet)
            setImages(images, worksheet, workbook)
            setColumnWidth(columnWidth, worksheet)
            //è¡Œé«˜è®¾ç½®50å¯¼å‡ºååœ¨ms-excelä¸­æ‰“å¼€æ˜¾ç¤º25ï¼Œåœ¨wps-excelä¸­æ‰“å¼€æ˜¾ç¤º50è¿™ä¸ªbugä¸ä¼šä¿®å¤
            setRowHeight(rowHeight, worksheet, excelType)
            setFrozen(frozen, worksheet)
            setRowHidden(rowhidden, worksheet)
            setColHidden(colhidden, worksheet)
            setFilter(filterSelect, worksheet)
            return true
        })

        // 4.å†™å…¥ buffer
        const buffer = workbook.xlsx.writeBuffer().then(data => {
            const blob = new Blob([data], {
                type: 'application/vnd.ms-excel;charset=utf-8'
            })

            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', blob, `${name}`);
            // åˆ›å»ºXMLHttpRequestå¯¹è±¡
            const xhr = new XMLHttpRequest();
            // é…ç½®è¯·æ±‚
            xhr.open('POST', uploadUrl, true);
            // è®¾ç½®è¯·æ±‚å®Œæˆçš„å›è°ƒå‡½æ•°
            xhr.onload = function () {
                if (xhr.status === 200) {
                    notice('å·²ä¸Šä¼ æˆåŠŸï¼')
                    console.log('Success:', xhr.responseText);
                } else {
                    notice('ä¸Šä¼ å¤±è´¥ï¼' + xhr.statusText)
                    console.error('Error:', xhr.statusText);
                }
            };
            // è®¾ç½®è¯·æ±‚å¤±è´¥çš„å›è°ƒå‡½æ•°
            xhr.onerror = function () {
                console.error('Network error occurred');
            };
            // è®¾ç½®è¯·æ±‚è¶…æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼‰
            xhr.ontimeout = function (e) {
                console.error('Request timed out');
            };
            // è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆå¯é€‰ï¼‰
            xhr.timeout = 5000; // 5ç§’
            // å‘é€FormDataå¯¹è±¡
            // è®¾ç½®è¯·æ±‚å¤´ï¼ˆå¯é€‰ï¼ŒæŸäº›æµè§ˆå™¨å¯èƒ½ä¸éœ€è¦ï¼‰
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        })

        return buffer
    }

    /**
     * ä¸‹è½½Excel
     * @param luckysheet    -> luckysheetçš„æ‰€æœ‰sheet
     * @param name          -> ä¿å­˜æ–‡ä»¶åï¼ˆå¦‚ï¼ša.xlsxï¼‰
     * @param excelType     -> office/wps
     */
    var exportExcelFront = function (luckysheet, name, excelType) {
        // 1.åˆ›å»ºå·¥ä½œç°¿ï¼Œå¯ä»¥ä¸ºå·¥ä½œç°¿æ·»åŠ å±æ€§
        const workbook = new ExcelJS.Workbook()
        // 2.åˆ›å»ºè¡¨æ ¼ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥é…ç½®åˆ›å»ºä»€ä¹ˆæ ·çš„å·¥ä½œè¡¨
        luckysheet.forEach(function (table) {
            // debugger
            if (table.data.length === 0) return true
            const worksheet = workbook.addWorksheet(table.name)
            const merge = (table.config && table.config.merge) || {}        //åˆå¹¶å•å…ƒæ ¼
            const borderInfo = (table.config && table.config.borderInfo) || {}      //è¾¹æ¡†
            const columnWidth = (table.config && table.config.columnlen) || {}    //åˆ—å®½
            const rowHeight = (table.config && table.config.rowlen) || {}      //è¡Œé«˜
            const frozen = table.frozen || {}       //å†»ç»“
            const rowhidden = (table.config && table.config.rowhidden) || {}    //è¡Œéšè—
            const colhidden = (table.config && table.config.colhidden) || {}    //åˆ—éšè—
            const filterSelect = table.filter_select || {}    //ç­›é€‰
            const images = table.images || {}   //å›¾ç‰‡
            // console.log(table)
            const hide = table.hide;    //å·¥ä½œè¡¨ sheet 1éšè—
            if (hide === 1) {
                // éšè—å·¥ä½œè¡¨
                worksheet.state = 'hidden';
            }
            setStyleAndValue(table.data, worksheet)
            setMerge(merge, worksheet)
            setBorder(borderInfo, worksheet)
            setImages(images, worksheet, workbook)
            setColumnWidth(columnWidth, worksheet)
            //è¡Œé«˜è®¾ç½®50å¯¼å‡ºååœ¨ms-excelä¸­æ‰“å¼€æ˜¾ç¤º25ï¼Œåœ¨wps-excelä¸­æ‰“å¼€æ˜¾ç¤º50è¿™ä¸ªbugä¸ä¼šä¿®å¤
            setRowHeight(rowHeight, worksheet, excelType)
            setFrozen(frozen, worksheet)
            setRowHidden(rowhidden, worksheet)
            setColHidden(colhidden, worksheet)
            setFilter(filterSelect, worksheet)
            return true
        })

        // 4.å†™å…¥ buffer
        const buffer = workbook.xlsx.writeBuffer().then(data => {
            const blob = new Blob([data], {
                type: 'application/vnd.ms-excel;charset=utf-8'
            })

            // æµè§ˆå™¨ä¸‹è½½æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç 
            console.log("å¯¼å‡ºæˆåŠŸï¼")
            saveAs(blob, `${name}`)
        })

        return buffer
    }


    /**
     * åˆ—å®½
     * @param columnWidth
     * @param worksheet
     */
    var setColumnWidth = function (columnWidth, worksheet) {
        for (let key in columnWidth) {
            worksheet.getColumn(parseInt(key) + 1).width = columnWidth[key] / 7.5
        }
    }

    /**
     * è¡Œé«˜
     * @param rowHeight
     * @param worksheet
     * @param excelType
     */
    var setRowHeight = function (rowHeight, worksheet, excelType) {
        //å¯¼å‡ºçš„æ–‡ä»¶ç”¨wpsæ‰“å¼€å’Œç”¨excelæ‰“å¼€æ˜¾ç¤ºçš„è¡Œé«˜å¤§ä¸€å€
        if (excelType == "wps") {
            for (let key in rowHeight) {
                worksheet.getRow(parseInt(key) + 1).height = rowHeight[key] * 0.75
            }
        }
        if (excelType == "office" || excelType == undefined) {
            for (let key in rowHeight) {
                worksheet.getRow(parseInt(key) + 1).height = rowHeight[key] * 1.5
            }
        }
    }

    /**
     * åˆå¹¶å•å…ƒæ ¼
     * @param luckyMerge
     * @param worksheet
     */
    var setMerge = function (luckyMerge = {}, worksheet) {
        const mergearr = Object.values(luckyMerge)
        mergearr.forEach(function (elem) {
            // elemæ ¼å¼ï¼š{r: 0, c: 0, rs: 1, cs: 2}
            // æŒ‰å¼€å§‹è¡Œï¼Œå¼€å§‹åˆ—ï¼Œç»“æŸè¡Œï¼Œç»“æŸåˆ—åˆå¹¶ï¼ˆç›¸å½“äº K10:M12ï¼‰
            worksheet.mergeCells(
                elem.r + 1,
                elem.c + 1,
                elem.r + elem.rs,
                elem.c + elem.cs
            )
        })
    }

    /**
     * è®¾ç½®è¾¹æ¡†
     * @param luckyBorderInfo
     * @param worksheet
     */
    var setBorder = function (luckyBorderInfo, worksheet) {
        if (!Array.isArray(luckyBorderInfo)) return

        //åˆå¹¶è¾¹æ¡†ä¿¡æ¯
        var mergeCellBorder = function (border1, border2) {
            if (undefined === border1 || Object.keys(border1).length === 0) return border2;
            return Object.assign({}, border1, border2)
        }

        // console.log('luckyBorderInfo', luckyBorderInfo)
        luckyBorderInfo.forEach(function (elem) {
            // ç°åœ¨åªå…¼å®¹åˆ°borderType ä¸ºrangeçš„æƒ…å†µ
            // console.log('ele', elem)
            if (elem.rangeType === 'range') {
                let border = borderConvert(elem.borderType, elem.style, elem.color)
                let rang = elem.range[0]
                let row = rang.row
                let column = rang.column

                let rowBegin = row[0]
                let rowEnd = row[1]
                let colBegin = column[0]
                let colEnd = column[1]
                //å¤„ç†å¤–è¾¹æ¡†çš„æƒ…å†µ æ²¡æœ‰ç›´æ¥å¯¹åº”çš„å¤–è¾¹æ¡† éœ€è¦è½¬æ¢æˆä¸Šä¸‹å·¦å³
                if (border.all) {//å…¨éƒ¨è¾¹æ¡†
                    let b = border.all
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            border['top'] = b;
                            border['bottom'] = b;
                            border['left'] = b;
                            border['right'] = b;
                            worksheet.getCell(i, y).border = border
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.top) {//ä¸Šè¾¹æ¡†
                    let b = border.top
                    let i = row[0] + 1;
                    for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                        let border = {}
                        border['top'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.right) {//å³è¾¹æ¡†
                    let b = border.right
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        let y = column[1] + 1;
                        let border = {}
                        border['right'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.bottom) {//ä¸‹è¾¹æ¡†
                    let b = border.bottom
                    let i = row[1] + 1;
                    for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                        let border = {}

                        border['bottom'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.left) {//å·¦è¾¹æ¡†
                    let b = border.left
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        let y = column[0] + 1;
                        let border = {}
                        border['left'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.outside) {//å¤–è¾¹æ¡†
                    let b = border.outside
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i === rowBegin + 1) {
                                border['top'] = b
                            }
                            if (i === rowEnd + 1) {
                                border['bottom'] = b
                            }
                            if (y === colBegin + 1) {
                                border['left'] = b
                            }
                            if (y === colEnd + 1) {
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.inside) {//å†…è¾¹æ¡†
                    let b = border.inside
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i !== rowBegin + 1) {
                                border['top'] = b
                            }
                            if (i !== rowEnd + 1) {
                                border['bottom'] = b
                            }
                            if (y !== colBegin + 1) {
                                border['left'] = b
                            }
                            if (y !== colEnd + 1) {
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.horizontal) {//å†…ä¾§æ°´å¹³è¾¹æ¡†
                    let b = border.horizontal
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i === rowBegin + 1) {
                                border['bottom'] = b
                            } else if (i === rowEnd + 1) {
                                border['top'] = b
                            } else {
                                border['top'] = b
                                border['bottom'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.vertical) {//å†…ä¾§å‚ç›´è¾¹æ¡†
                    let b = border.vertical
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (y === colBegin + 1) {
                                border['right'] = b
                            } else if (y === colEnd + 1) {
                                border['left'] = b
                            } else {
                                border['left'] = b
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.none) {//å½“luckysheetè¾¹æ¡†ä¸ºborder-noneçš„æ—¶å€™è¡¨ç¤ºæ²¡æœ‰è¾¹æ¡† åˆ™å°†å¯¹åº”çš„å•å…ƒæ ¼borderæ¸…ç©º
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            worksheet.getCell(i, y).border = {}
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                }
            }
            if (elem.rangeType === 'cell') {
                // col_index: 2
                // row_index: 1
                // b: {
                //   color: '#d0d4e3'
                //   style: 1
                // }
                const {col_index, row_index} = elem.value
                const borderData = Object.assign({}, elem.value)
                delete borderData.col_index
                delete borderData.row_index
                let border = addborderToCell(borderData, row_index, col_index)
                let border1 = worksheet.getCell(row_index + 1, col_index + 1).border;
                worksheet.getCell(row_index + 1, col_index + 1).border = mergeCellBorder(border1, border)
                // console.log(row_index + 1, col_index + 1, worksheet.getCell(row_index + 1, col_index + 1).border)
            }
        })
    }


    /**
     * è®¾ç½®å¸¦æ ·å¼çš„å€¼
     * @param cellArr
     * @param worksheet
     */
    var setStyleAndValue = function (cellArr, worksheet) {
        if (!Array.isArray(cellArr)) return
        cellArr.forEach(function (row, rowid) {
            row.every(function (cell, columnid) {
                if (!cell) return true
                let fill = fillConvert(cell.bg)

                let font = fontConvert(
                    cell.ff,
                    cell.fc,
                    cell.bl,
                    cell.it,
                    cell.fs,
                    cell.cl,
                    cell.un
                )
                let alignment = alignmentConvert(cell.vt, cell.ht, cell.tb, cell.tr)
                let value = ''

                if (cell.f) {
                    value = {formula: cell.f, result: cell.v}
                } else if (!cell.v && cell.ct && cell.ct.s) {
                    // xlsè½¬ä¸ºxlsxä¹‹åï¼Œå†…éƒ¨å­˜åœ¨ä¸åŒçš„æ ¼å¼ï¼Œéƒ½ä¼šè¿›åˆ°å¯Œæ–‡æœ¬é‡Œï¼Œå³å€¼ä¸å­˜åœ¨ä¸cell.vï¼Œè€Œæ˜¯å­˜åœ¨äºcell.ct.sä¹‹å
                    let richText = [];
                    let cts = cell.ct.s
                    for (let i = 0; i < cts.length; i++) {
                        let rt = {
                            text: cts[i].v,
                            font: fontConvert(cts[i].ff, cts[i].fc, cts[i].bl, cts[i].it, cts[i].fs, cts[i].cl, cts[i].un)
                        }
                        richText.push(rt)
                    }
                    value = {
                        richText: richText
                    };

                } else {
                    //è®¾ç½®å€¼ä¸ºæ•°å­—æ ¼å¼
                    if (cell.v !== undefined && cell.v !== '') {
                        var v = +cell.v;
                        if (isNaN(v)) v = cell.v
                        value = v
                    }
                }
                //  style å¡«å…¥åˆ°_valueä¸­å¯ä»¥å®ç°å¡«å……è‰²
                let letter = createCellPos(columnid)
                let target = worksheet.getCell(letter + (rowid + 1))
                // console.log('1233', letter + (rowid + 1))
                for (const key in fill) {
                    target.fill = fill
                    break
                }
                target.font = font
                target.alignment = alignment
                target.value = value

                try {
                    //è®¾ç½®å•å…ƒæ ¼æ ¼å¼
                    target.numFmt = cell.ct.fa;
                } catch (e) {
                    console.warn(e)
                }

                return true
            })
        })
    }

    /**
     * è®¾ç½®å›¾ç‰‡
     * @param images
     * @param worksheet
     * @param workbook
     */
    var setImages = function (images, worksheet, workbook) {
        if (typeof images != "object") return;
        for (let key in images) {
            // console.log(images[key]);
            // "data:image/png;base64,iVBORw0KG..."
            // é€šè¿‡ base64  å°†å›¾åƒæ·»åŠ åˆ°å·¥ä½œç°¿
            const myBase64Image = images[key].src;
            //ä½ç½®
            const tl = {col: images[key].default.left / 72, row: images[key].default.top / 19}
            // å¤§å°
            const ext = {width: images[key].default.width, height: images[key].default.height}
            const imageId = workbook.addImage({
                base64: myBase64Image,
                //extension: 'png',
            });
            worksheet.addImage(imageId, {
                tl: tl,
                ext: ext
            });
        }
    }

    /**
     * å†»ç»“è¡Œåˆ—
     * @param frozen
     * @param worksheet
     */
    var setFrozen = function (frozen = {}, worksheet) {
        switch (frozen.type) {
            // å†»ç»“é¦–è¡Œ
            case 'row': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 0, ySplit: 1}
                ];
                break
            }
            // å†»ç»“é¦–åˆ—
            case 'column': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 1, ySplit: 0}
                ];
                break
            }
            // å†»ç»“è¡Œåˆ—
            case 'both': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 1, ySplit: 1}
                ];
                break
            }
            // å†»ç»“è¡Œåˆ°é€‰åŒº
            case 'rangeRow': {
                let row = frozen.range.row_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: 0, ySplit: row}
                ];
                break
            }
            // å†»ç»“åˆ—åˆ°é€‰åŒº
            case 'rangeColumn': {
                let column = frozen.range.column_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: column, ySplit: 0}
                ];
                break
            }
            // å†»ç»“è¡Œåˆ—åˆ°é€‰åŒº
            case 'rangeBoth': {
                let row = frozen.range.row_focus + 1
                let column = frozen.range.column_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: column, ySplit: row}
                ];
            }

        }

    }

    /**
     * è¡Œéšè—
     * @param rowhidden
     * @param worksheet
     */
    var setRowHidden = function (rowhidden = {}, worksheet) {
        for (const key in rowhidden) {
            //å¦‚æœå½“å‰è¡Œæ²¡æœ‰å†…å®¹åˆ™éšè—ä¸ç”Ÿæ•ˆ
            const row = worksheet.getRow(parseInt(key) + 1)
            row.hidden = true;
        }
    }

    /**
     * åˆ—éšè—
     * @param colhidden
     * @param worksheet
     */
    var setColHidden = function (colhidden = {}, worksheet) {
        for (const key in colhidden) {
            const column = worksheet.getColumn(parseInt(key) + 1)
            column.hidden = true;
        }
    }

    /**
     * è‡ªåŠ¨ç­›é€‰å™¨
     * @param filter
     * @param worksheet
     */
    var setFilter = function (filter = {}, worksheet) {
        if (Object.keys(filter).length === 0) return
        const from = {
            row: filter.row[0] + 1,
            column: filter.column[0] + 1
        }

        const to = {
            row: filter.row[1] + 1,
            column: filter.column[1] + 1
        }

        worksheet.autoFilter = {
            from: from,
            to: to
        }

    }

    var fillConvert = function (bg) {
        if (!bg) {
            return {}
        }
        // const bgc = bg.replace('#', '')
        let fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: {argb: bg.startsWith("#") ? bg.replace('#', '') : colorRGBtoHex(bg).replace("#", "")},
        }
        return fill;
    }

    var fontConvert = function (
        ff = 0,
        fc = '#000000',
        bl = 0,
        it = 0,
        fs = 10,
        cl = 0,
        ul = 0
    ) {
        // luckysheetï¼šff(æ ·å¼), fc(é¢œè‰²), bl(ç²—ä½“), it(æ–œä½“), fs(å¤§å°), cl(åˆ é™¤çº¿), ul(ä¸‹åˆ’çº¿)
        const luckyToExcel = {
            0: 'å¾®è½¯é›…é»‘',
            1: 'å®‹ä½“ï¼ˆSongï¼‰',
            2: 'é»‘ä½“ï¼ˆST Heitiï¼‰',
            3: 'æ¥·ä½“ï¼ˆST Kaitiï¼‰',
            4: 'ä»¿å®‹ï¼ˆST FangSongï¼‰',
            5: 'æ–°å®‹ä½“ï¼ˆST Songï¼‰',
            6: 'åæ–‡æ–°é­',
            7: 'åæ–‡è¡Œæ¥·',
            8: 'åæ–‡éš¶ä¹¦',
            9: 'Arial',
            10: 'Times New Roman ',
            11: 'Tahoma ',
            12: 'Verdana',
            num2bl: function (num) {
                return num !== 0
            }
        }
        // å‡ºç°Bugï¼Œå¯¼å…¥çš„æ—¶å€™ffä¸ºluckyToExcelçš„val

        let font = {
            name: typeof ff === 'number' ? luckyToExcel[ff] : ff,
            family: 1,
            size: fs,
            color: {argb: fc.startsWith("#") ? fc.replace('#', '') : colorRGBtoHex(fc).replace("#", "")},
            bold: luckyToExcel.num2bl(bl),
            italic: luckyToExcel.num2bl(it),
            underline: luckyToExcel.num2bl(ul),
            strike: luckyToExcel.num2bl(cl)
        }

        return font
    }

    var alignmentConvert = function (
        vt = 'default',
        ht = 'default',
        tb = 'default',
        tr = 'default'
    ) {
        // luckysheet:vt(å‚ç›´), ht(æ°´å¹³), tb(æ¢è¡Œ), tr(æ—‹è½¬)
        const luckyToExcel = {
            vertical: {
                0: 'middle',
                1: 'top',
                2: 'bottom',
                default: 'middle'
            },
            horizontal: {
                0: 'center',
                1: 'left',
                2: 'right',
                default: 'center'
            },
            wrapText: {
                0: false,
                1: false,
                2: true,
                default: false
            },
            textRotation: {
                0: 0,
                1: 45,
                2: -45,
                3: 'vertical',
                4: 90,
                5: -90,
                default: 0
            }
        }

        let alignment = {
            vertical: luckyToExcel.vertical[vt],
            horizontal: luckyToExcel.horizontal[ht],
            wrapText: luckyToExcel.wrapText[tb],
            textRotation: luckyToExcel.textRotation[tr]
        }
        return alignment
    }

    var borderConvert = function (borderType, style = 1, color = '#000') {
        // å¯¹åº”luckysheetçš„configä¸­borderinfoçš„çš„å‚æ•°
        if (!borderType) {
            return {}
        }
        const luckyToExcel = {
            type: {
                'border-all': 'all',
                'border-top': 'top',
                'border-right': 'right',
                'border-bottom': 'bottom',
                'border-left': 'left',
                'border-outside': 'outside',
                'border-inside': 'inside',
                'border-horizontal': 'horizontal',
                'border-vertical': 'vertical',
                'border-none': 'none',
            },
            style: {
                0: 'none',
                1: 'thin',
                2: 'hair',
                3: 'dotted',
                4: 'dashDot', // 'Dashed',
                5: 'dashDot',
                6: 'dashDotDot',
                7: 'double',
                8: 'medium',
                9: 'mediumDashed',
                10: 'mediumDashDot',
                11: 'mediumDashDotDot',
                12: 'slantDashDot',
                13: 'thick'
            }
        }
        let border = {}
        border[luckyToExcel.type[borderType]] = {
            style: luckyToExcel.style[style],
            color: {argb: color.replace('#', '')}
        }
        return border
    }

    function addborderToCell(borders, row_index, col_index) {
        let border = {}
        const luckyExcel = {
            type: {
                l: 'left',
                r: 'right',
                b: 'bottom',
                t: 'top'
            },
            style: {
                0: 'none',
                1: 'thin',
                2: 'hair',
                3: 'dotted',
                4: 'dashDot', // 'Dashed',
                5: 'dashDot',
                6: 'dashDotDot',
                7: 'double',
                8: 'medium',
                9: 'mediumDashed',
                10: 'mediumDashDot',
                11: 'mediumDashDotDot',
                12: 'slantDashDot',
                13: 'thick'
            }
        }
        // console.log('borders', borders)
        for (const bor in borders) {
            // console.log(bor)
            if (borders[bor].color.indexOf('rgb') === -1) {
                border[luckyExcel.type[bor]] = {
                    style: luckyExcel.style[borders[bor].style],
                    color: {argb: borders[bor].color.replace('#', '')}
                }
            } else {
                border[luckyExcel.type[bor]] = {
                    style: luckyExcel.style[borders[bor].style],
                    color: {argb: borders[bor].color}
                }
            }
        }

        return border
    }

    function createCellPos(n) {
        let ordA = 'A'.charCodeAt(0)

        let ordZ = 'Z'.charCodeAt(0)
        let len = ordZ - ordA + 1
        let s = ''
        while (n >= 0) {
            s = String.fromCharCode((n % len) + ordA) + s

            n = Math.floor(n / len) - 1
        }
        return s
    }

    //rgb(255,255,255)è½¬16è¿›åˆ¶ #ffffff
    function colorRGBtoHex(color) {
        color = color.replace("rgb", "").replace("(", "").replace(")", "")
        var rgb = color.split(',');
        var r = parseInt(rgb[0]);
        var g = parseInt(rgb[1]);
        var b = parseInt(rgb[2]);
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
</script>
</body>

</html>