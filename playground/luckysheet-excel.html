<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <title>Luckysheet-excel</title>

    <!-- ÂºïÂÖ•luckysheetÔºåÁî®‰∫éÊ∏≤ÊüìË°®Ê†º -->
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css'/>
    <link rel='stylesheet' href='http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css'/>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <!-- ÂºïÂÖ•exceljs„ÄÅFileSaverÔºåÁî®‰∫éluckysheetË°®Ê†ºËΩ¨xlsxÊñá‰ª∂ -->
    <script src="http://localhost/cqiu/tools/static/cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.bootcdn.net/ajax/libs/exceljs/4.3.0/exceljs.js"></script>
    <script src="http://localhost/cqiu/tools/static/cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>
    <script>
        $(function () {
            //Configuration item
            var options = {
                container: 'luckysheet', //luckysheet is the container id
                showinfobar: false,
                title: 'Âú®Á∫øË°®Ê†º', // ËÆæÂÆöË°®Ê†ºÂêçÁß∞
                lang: 'zh' // ËÆæÂÆöË°®Ê†ºËØ≠Ë®Ä
            }
            luckysheet.create(options)
        });
    </script>
    <style>
        .overwrite {
            color: red
        }
    </style>
</head>

<body>
<div id="lucky-mask-demo"
     style="position: absolute;z-index: 1000000;left: 0px;top: 0px;bottom: 0px;right: 0px; background: rgba(255, 255, 255, 0.8); text-align: center;font-size: 40px;align-items:center;justify-content: center;display: none;">
    download...
</div>
<div id="luckysheet"
     style="margin:0px;padding:0px;position:absolute;width:100%;left: 0px;top: 0;bottom: 0px;outline: none;">
</div>
<div style="z-index: 0;position: fixed; left: 0; bottom: 0;max-width: 50%;width: 380px; line-height: 20px;height: 20px;display: flex;">
    <label onclick="" style="display: flex" title="‰∏çÂèòÂàô‰∏ç‰ºöÈáçÊñ∞Âä†ËΩΩ">üìÇ
        <input style="font-size:16px;display:none" type="file" id="select-file" name="select-file"/>
    </label>
    <input type="text" name="filename" id="filename" list="files" value="" title="ÂΩìÂøÉ‰∏¢Â§±orË¶ÜÁõñ">
    <datalist id="files"></datalist>

    <!--ÊàñÂä†ËΩΩËøúÁ®ã xlsx Êñá‰ª∂Ôºö
    <select style="height: 27px;top: -2px;position: relative;" id="Luckyexcel-select-demo">
        <option value="">ÈÄâÊã©ÁΩëÁªúÊñá‰ª∂</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/money-manager-2.xlsx">Money Manager.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Activity%20costs%20tracker.xlsx">Activity costs tracker.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/House%20cleaning%20checklist.xlsx">House cleaning checklist.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Student%20assignment%20planner.xlsx">Student assignment planner.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Credit%20card%20tracker.xlsx">Credit card tracker.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Blue%20timesheet.xlsx">Blue timesheet.xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Student%20calendar%20%28Mon%29.xlsx">Student calendar (Mon).xlsx</option>
        <option value="https://minio.cnbabylon.com/public/luckysheet/Blue%20mileage%20and%20expense%20report.xlsx">Blue mileage and expense report.xlsx</option>
    </select>-->
    <a style="cursor: pointer;padding:0;border:none" id="downlod-file" title="‰∏ãËΩΩ">‚è¨</a>
    <a style="cursor: pointer;padding:0;border:none" id="save-file" title="‰øùÂ≠òÂà∞ÊúçÂä°Âô®">‚è´</a>
    <!--  üíæ Âä†‰∫Ü‰∏ãÈù¢ËøôË°åÔºå‰∏äÈù¢ÁöÑdatalistÊâçÊòæÁ§∫ÂºπÂá∫Ê°ÜÔºåÂ•áÊÄ™ÈóÆÈ¢ò -->
    <input type="text" list="files2" name="filename2" id="filename2" style="display:none">
    <datalist id="files2">
        <option value="Option1">
    </datalist>
    <span id="msg" style="font-size:12px"></span>
</div>

<script>
    let ext = 'xlsx';
    let uploadUrl = './saver.php?act=upload';
    let fullName = 'Excel-1'; // Ê≠£Âú®ÁºñËæëÁöÑExcelÊñá‰ª∂ÂêçÔºåÂåÖÂê´ÂêéÁºÄÂêç
    function notice(msg) {
        let div = document.getElementById("msg");
        div.innerHTML = msg;
        setTimeout(function () {
            div.style.opacity = 0.5;
            setTimeout(function () {
                div.style.opacity = 1;
                div.innerHTML = "";
            }, 1000);
        }, 2000);
    }

    function starter() {
        let filename = document.getElementById("filename");
        let selectBtn = document.getElementById("select-file");
        // let selectADemo = document.getElementById("Luckyexcel-select-demo");
        let downloadBtn = document.getElementById("downlod-file");
        let uploadBtn = document.getElementById("save-file");
        let mask = document.getElementById("lucky-mask-demo");

        window.onload = () => {
            filename.addEventListener('change', function () {
                fullName = filename.value;
                document.title = filename.value;
                console.log('changed!', filename.value);
            });
            // filename.value = fullName;
            // filename.dispatchEvent(new Event('change'));
            // Âä†ËΩΩËøúÁ®ãÊñá‰ª∂s
            filename.onfocus = function () {
                this.select();
                document.getElementById('files').style.display = "block";
                if (filename.list.options.length > 0) return true;
                fetch('saver.php?act=files&ext=' + ext)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        data.forEach(function (item) {
                            let option = document.createElement('option');
                            option.value = item;
                            filename.list.appendChild(option);
                        });
                    });
            };
            filename.addEventListener('input', function () {
                console.log('remove class overwrite')
                filename.classList.remove('overwrite');
                // Ê£ÄÊü•inputÁöÑÂÄºÊòØÂê¶Âú®datalistÁöÑÈÄâÈ°π‰∏≠
                var found = Array.prototype.some.call(filename.list.options, function (option) {
                    return option.value === filename.value;
                });

                if (found) {
                    // Âä†ËΩΩËøúÁ®ãÊñá‰ª∂
                    loadRemoteExcel(filename.value + '.' + ext, filename.value);

                }
            });

            selectBtn.addEventListener("change", function (evt) {
                var files = evt.target.files;
                if (files == null || files.length == 0) {
                    alert("No files wait for import");
                    return;
                }

                let name = files[0].name;
                let suffixArr = name.split("."), suffix = suffixArr[suffixArr.length - 1];
                if (suffix != ext) {
                    alert("Currently only supports the import of xlsx files");
                    return;
                }
                suffixArr.pop();
                name = suffixArr.join(".");
                var found = Array.prototype.some.call(filename.list.options, function (option) {
                    return option.value === name;
                });

                if (found) {
                    console.log('add class overwrite')
                    filename.classList.add('overwrite');
                }
                filename.value = name;
                filename.dispatchEvent(new Event('change'));
                LuckyExcel.transformExcelToLucky(files[0], function (exportJson, luckysheetfile) {

                    if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                        alert("Failed to read the content of the excel file, currently does not support xls files!");
                        return;
                    }
                    window.luckysheet.destroy();

                    window.luckysheet.create({
                        container: 'luckysheet', //luckysheet is the container id
                        showinfobar: false,
                        data: exportJson.sheets,
                        title: 'Âú®Á∫øË°®Ê†º',
                        userInfo: exportJson.info.name.creator,
                        lang: 'zh'
                    });
                });
            });

            var loadRemoteExcel = function (url, name) {
                if (!url) {
                    return;
                }
                mask.style.display = "flex";
                LuckyExcel.transformExcelToLuckyByUrl(url, name, function (exportJson, luckysheetfile) {
                    if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                        alert("Failed to read the content of the excel file, currently does not support xls files!");
                        return;
                    }
                    // console.log(exportJson, luckysheetfile);
                    mask.style.display = "none";
                    window.luckysheet.destroy();

                    window.luckysheet.create({
                        container: 'luckysheet', //luckysheet is the container id
                        showinfobar: false,
                        data: exportJson.sheets,
                        title: 'Âú®Á∫øË°®Ê†º',
                        userInfo: exportJson.info.name.creator,
                        lang: 'zh'
                    });
                });
            }

            /*selectADemo.addEventListener("change", function (evt) {
                var obj = selectADemo;
                var index = obj.selectedIndex;
                var value = obj.options[index].value;
                var name = obj.options[index].innerHTML;
                if (value == "") {
                    return;
                }
                filename.value = name;
                filename.dispatchEvent(new Event('change'));
                loadRemoteExcel(value, name);
            });*/

            uploadBtn.addEventListener("click", function (evt) {
                if (!filename.value) {
                    notice('ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç');
                    return;
                }
                uploadExcel(window.luckysheet.getAllSheets(), filename.value + '.' + ext)  // ‰∏ä‰º†Âà∞ÊúçÂä°Âô®
            });

            downloadBtn.addEventListener("click", function (evt) {
                if (!filename.value) {
                    notice('ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç');
                    return;
                }
                exportExcelFront(window.luckysheet.getAllSheets(), filename.value + '.' + ext) // ‰∏ãËΩΩExcel

                // var obj = selectADemo;
                // var index = obj.selectedIndex;
                // var value = obj.options[index].value;
                // if (value.length == 0) {
                //     alert("Please select a demo file");
                //     return;
                // }
                // var elemIF = document.getElementById("Lucky-download-frame");
                // if (elemIF == null) {
                //     elemIF = document.createElement("iframe");
                //     elemIF.style.display = "none";
                //     elemIF.id = "Lucky-download-frame";
                //     document.body.appendChild(elemIF);
                // }
                // elemIF.src = value;

            });
        }
    }
    starter();


    /**
     * ‰∏ä‰º†Âà∞ÊúçÂä°Âô®
     * @param luckysheet    -> luckysheetÁöÑÊâÄÊúâsheet
     * @param name          -> ‰øùÂ≠òÊñá‰ª∂ÂêçÔºàÂ¶ÇÔºöa.xlsxÔºâ
     * @param excelType     -> office/wps
     */
    var uploadExcel = function (luckysheet, name, excelType) {
        // 1.ÂàõÂª∫Â∑•‰ΩúÁ∞øÔºåÂèØ‰ª•‰∏∫Â∑•‰ΩúÁ∞øÊ∑ªÂä†Â±ûÊÄß
        const workbook = new ExcelJS.Workbook()
        // 2.ÂàõÂª∫Ë°®Ê†ºÔºåÁ¨¨‰∫å‰∏™ÂèÇÊï∞ÂèØ‰ª•ÈÖçÁΩÆÂàõÂª∫‰ªÄ‰πàÊ†∑ÁöÑÂ∑•‰ΩúË°®
        luckysheet.forEach(function (table) {
            // debugger
            if (table.data.length === 0) return true
            const worksheet = workbook.addWorksheet(table.name)
            const merge = (table.config && table.config.merge) || {}        //ÂêàÂπ∂ÂçïÂÖÉÊ†º
            const borderInfo = (table.config && table.config.borderInfo) || {}      //ËæπÊ°Ü
            const columnWidth = (table.config && table.config.columnlen) || {}    //ÂàóÂÆΩ
            const rowHeight = (table.config && table.config.rowlen) || {}      //Ë°åÈ´ò
            const frozen = table.frozen || {}       //ÂÜªÁªì
            const rowhidden = (table.config && table.config.rowhidden) || {}    //Ë°åÈöêËóè
            const colhidden = (table.config && table.config.colhidden) || {}    //ÂàóÈöêËóè
            const filterSelect = table.filter_select || {}    //Á≠õÈÄâ
            const images = table.images || {}   //ÂõæÁâá
            // console.log(table)
            const hide = table.hide;    //Â∑•‰ΩúË°® sheet 1ÈöêËóè
            if (hide === 1) {
                // ÈöêËóèÂ∑•‰ΩúË°®
                worksheet.state = 'hidden';
            }
            setStyleAndValue(table.data, worksheet)
            setMerge(merge, worksheet)
            setBorder(borderInfo, worksheet)
            setImages(images, worksheet, workbook)
            setColumnWidth(columnWidth, worksheet)
            //Ë°åÈ´òËÆæÁΩÆ50ÂØºÂá∫ÂêéÂú®ms-excel‰∏≠ÊâìÂºÄÊòæÁ§∫25ÔºåÂú®wps-excel‰∏≠ÊâìÂºÄÊòæÁ§∫50Ëøô‰∏™bug‰∏ç‰ºö‰øÆÂ§ç
            setRowHeight(rowHeight, worksheet, excelType)
            setFrozen(frozen, worksheet)
            setRowHidden(rowhidden, worksheet)
            setColHidden(colhidden, worksheet)
            setFilter(filterSelect, worksheet)
            return true
        })

        // 4.ÂÜôÂÖ• buffer
        const buffer = workbook.xlsx.writeBuffer().then(data => {
            const blob = new Blob([data], {
                type: 'application/vnd.ms-excel;charset=utf-8'
            })

            // ÂàõÂª∫FormDataÂØπË±°
            const formData = new FormData();
            formData.append('file', blob, `${name}`);
            // ÂàõÂª∫XMLHttpRequestÂØπË±°
            const xhr = new XMLHttpRequest();
            // ÈÖçÁΩÆËØ∑Ê±Ç
            xhr.open('POST', uploadUrl, true);
            // ËÆæÁΩÆËØ∑Ê±ÇÂÆåÊàêÁöÑÂõûË∞ÉÂáΩÊï∞
            xhr.onload = function () {
                if (xhr.status === 200) {
                    notice('Â∑≤‰∏ä‰º†ÊàêÂäüÔºÅ')
                    console.log('Success:', xhr.responseText);
                } else {
                    notice('‰∏ä‰º†Â§±Ë¥•ÔºÅ' + xhr.statusText)
                    console.error('Error:', xhr.statusText);
                }
            };
            // ËÆæÁΩÆËØ∑Ê±ÇÂ§±Ë¥•ÁöÑÂõûË∞ÉÂáΩÊï∞
            xhr.onerror = function () {
                console.error('Network error occurred');
            };
            // ËÆæÁΩÆËØ∑Ê±ÇË∂ÖÊó∂ÁöÑÂõûË∞ÉÂáΩÊï∞ÔºàÂèØÈÄâÔºâ
            xhr.ontimeout = function (e) {
                console.error('Request timed out');
            };
            // ËÆæÁΩÆËØ∑Ê±ÇË∂ÖÊó∂Êó∂Èó¥ÔºàÂèØÈÄâÔºâ
            xhr.timeout = 5000; // 5Áßí
            // ÂèëÈÄÅFormDataÂØπË±°
            // ËÆæÁΩÆËØ∑Ê±ÇÂ§¥ÔºàÂèØÈÄâÔºåÊüê‰∫õÊµèËßàÂô®ÂèØËÉΩ‰∏çÈúÄË¶ÅÔºâ
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        })

        return buffer
    }

    /**
     * ‰∏ãËΩΩExcel
     * @param luckysheet    -> luckysheetÁöÑÊâÄÊúâsheet
     * @param name          -> ‰øùÂ≠òÊñá‰ª∂ÂêçÔºàÂ¶ÇÔºöa.xlsxÔºâ
     * @param excelType     -> office/wps
     */
    var exportExcelFront = function (luckysheet, name, excelType) {
        // 1.ÂàõÂª∫Â∑•‰ΩúÁ∞øÔºåÂèØ‰ª•‰∏∫Â∑•‰ΩúÁ∞øÊ∑ªÂä†Â±ûÊÄß
        const workbook = new ExcelJS.Workbook()
        // 2.ÂàõÂª∫Ë°®Ê†ºÔºåÁ¨¨‰∫å‰∏™ÂèÇÊï∞ÂèØ‰ª•ÈÖçÁΩÆÂàõÂª∫‰ªÄ‰πàÊ†∑ÁöÑÂ∑•‰ΩúË°®
        luckysheet.forEach(function (table) {
            // debugger
            if (table.data.length === 0) return true
            const worksheet = workbook.addWorksheet(table.name)
            const merge = (table.config && table.config.merge) || {}        //ÂêàÂπ∂ÂçïÂÖÉÊ†º
            const borderInfo = (table.config && table.config.borderInfo) || {}      //ËæπÊ°Ü
            const columnWidth = (table.config && table.config.columnlen) || {}    //ÂàóÂÆΩ
            const rowHeight = (table.config && table.config.rowlen) || {}      //Ë°åÈ´ò
            const frozen = table.frozen || {}       //ÂÜªÁªì
            const rowhidden = (table.config && table.config.rowhidden) || {}    //Ë°åÈöêËóè
            const colhidden = (table.config && table.config.colhidden) || {}    //ÂàóÈöêËóè
            const filterSelect = table.filter_select || {}    //Á≠õÈÄâ
            const images = table.images || {}   //ÂõæÁâá
            // console.log(table)
            const hide = table.hide;    //Â∑•‰ΩúË°® sheet 1ÈöêËóè
            if (hide === 1) {
                // ÈöêËóèÂ∑•‰ΩúË°®
                worksheet.state = 'hidden';
            }
            setStyleAndValue(table.data, worksheet)
            setMerge(merge, worksheet)
            setBorder(borderInfo, worksheet)
            setImages(images, worksheet, workbook)
            setColumnWidth(columnWidth, worksheet)
            //Ë°åÈ´òËÆæÁΩÆ50ÂØºÂá∫ÂêéÂú®ms-excel‰∏≠ÊâìÂºÄÊòæÁ§∫25ÔºåÂú®wps-excel‰∏≠ÊâìÂºÄÊòæÁ§∫50Ëøô‰∏™bug‰∏ç‰ºö‰øÆÂ§ç
            setRowHeight(rowHeight, worksheet, excelType)
            setFrozen(frozen, worksheet)
            setRowHidden(rowhidden, worksheet)
            setColHidden(colhidden, worksheet)
            setFilter(filterSelect, worksheet)
            return true
        })

        // 4.ÂÜôÂÖ• buffer
        const buffer = workbook.xlsx.writeBuffer().then(data => {
            const blob = new Blob([data], {
                type: 'application/vnd.ms-excel;charset=utf-8'
            })

            // ÊµèËßàÂô®‰∏ãËΩΩÊñá‰ª∂ÁöÑÁ§∫‰æã‰ª£Á†Å
            console.log("ÂØºÂá∫ÊàêÂäüÔºÅ")
            saveAs(blob, `${name}`)
        })

        return buffer
    }


    /**
     * ÂàóÂÆΩ
     * @param columnWidth
     * @param worksheet
     */
    var setColumnWidth = function (columnWidth, worksheet) {
        for (let key in columnWidth) {
            worksheet.getColumn(parseInt(key) + 1).width = columnWidth[key] / 7.5
        }
    }

    /**
     * Ë°åÈ´ò
     * @param rowHeight
     * @param worksheet
     * @param excelType
     */
    var setRowHeight = function (rowHeight, worksheet, excelType) {
        //ÂØºÂá∫ÁöÑÊñá‰ª∂Áî®wpsÊâìÂºÄÂíåÁî®excelÊâìÂºÄÊòæÁ§∫ÁöÑË°åÈ´òÂ§ß‰∏ÄÂÄç
        if (excelType == "wps") {
            for (let key in rowHeight) {
                worksheet.getRow(parseInt(key) + 1).height = rowHeight[key] * 0.75
            }
        }
        if (excelType == "office" || excelType == undefined) {
            for (let key in rowHeight) {
                worksheet.getRow(parseInt(key) + 1).height = rowHeight[key] * 1.5
            }
        }
    }

    /**
     * ÂêàÂπ∂ÂçïÂÖÉÊ†º
     * @param luckyMerge
     * @param worksheet
     */
    var setMerge = function (luckyMerge = {}, worksheet) {
        const mergearr = Object.values(luckyMerge)
        mergearr.forEach(function (elem) {
            // elemÊ†ºÂºèÔºö{r: 0, c: 0, rs: 1, cs: 2}
            // ÊåâÂºÄÂßãË°åÔºåÂºÄÂßãÂàóÔºåÁªìÊùüË°åÔºåÁªìÊùüÂàóÂêàÂπ∂ÔºàÁõ∏ÂΩì‰∫é K10:M12Ôºâ
            worksheet.mergeCells(
                elem.r + 1,
                elem.c + 1,
                elem.r + elem.rs,
                elem.c + elem.cs
            )
        })
    }

    /**
     * ËÆæÁΩÆËæπÊ°Ü
     * @param luckyBorderInfo
     * @param worksheet
     */
    var setBorder = function (luckyBorderInfo, worksheet) {
        if (!Array.isArray(luckyBorderInfo)) return

        //ÂêàÂπ∂ËæπÊ°Ü‰ø°ÊÅØ
        var mergeCellBorder = function (border1, border2) {
            if (undefined === border1 || Object.keys(border1).length === 0) return border2;
            return Object.assign({}, border1, border2)
        }

        // console.log('luckyBorderInfo', luckyBorderInfo)
        luckyBorderInfo.forEach(function (elem) {
            // Áé∞Âú®Âè™ÂÖºÂÆπÂà∞borderType ‰∏∫rangeÁöÑÊÉÖÂÜµ
            // console.log('ele', elem)
            if (elem.rangeType === 'range') {
                let border = borderConvert(elem.borderType, elem.style, elem.color)
                let rang = elem.range[0]
                let row = rang.row
                let column = rang.column

                let rowBegin = row[0]
                let rowEnd = row[1]
                let colBegin = column[0]
                let colEnd = column[1]
                //Â§ÑÁêÜÂ§ñËæπÊ°ÜÁöÑÊÉÖÂÜµ Ê≤°ÊúâÁõ¥Êé•ÂØπÂ∫îÁöÑÂ§ñËæπÊ°Ü ÈúÄË¶ÅËΩ¨Êç¢Êàê‰∏ä‰∏ãÂ∑¶Âè≥
                if (border.all) {//ÂÖ®ÈÉ®ËæπÊ°Ü
                    let b = border.all
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            border['top'] = b;
                            border['bottom'] = b;
                            border['left'] = b;
                            border['right'] = b;
                            worksheet.getCell(i, y).border = border
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.top) {//‰∏äËæπÊ°Ü
                    let b = border.top
                    let i = row[0] + 1;
                    for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                        let border = {}
                        border['top'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.right) {//Âè≥ËæπÊ°Ü
                    let b = border.right
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        let y = column[1] + 1;
                        let border = {}
                        border['right'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.bottom) {//‰∏ãËæπÊ°Ü
                    let b = border.bottom
                    let i = row[1] + 1;
                    for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                        let border = {}

                        border['bottom'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.left) {//Â∑¶ËæπÊ°Ü
                    let b = border.left
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        let y = column[0] + 1;
                        let border = {}
                        border['left'] = b;
                        worksheet.getCell(i, y).border = border
                        // console.log(i, y, worksheet.getCell(i, y).border)
                    }
                } else if (border.outside) {//Â§ñËæπÊ°Ü
                    let b = border.outside
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i === rowBegin + 1) {
                                border['top'] = b
                            }
                            if (i === rowEnd + 1) {
                                border['bottom'] = b
                            }
                            if (y === colBegin + 1) {
                                border['left'] = b
                            }
                            if (y === colEnd + 1) {
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.inside) {//ÂÜÖËæπÊ°Ü
                    let b = border.inside
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i !== rowBegin + 1) {
                                border['top'] = b
                            }
                            if (i !== rowEnd + 1) {
                                border['bottom'] = b
                            }
                            if (y !== colBegin + 1) {
                                border['left'] = b
                            }
                            if (y !== colEnd + 1) {
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.horizontal) {//ÂÜÖ‰æßÊ∞¥Âπ≥ËæπÊ°Ü
                    let b = border.horizontal
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (i === rowBegin + 1) {
                                border['bottom'] = b
                            } else if (i === rowEnd + 1) {
                                border['top'] = b
                            } else {
                                border['top'] = b
                                border['bottom'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.vertical) {//ÂÜÖ‰æßÂûÇÁõ¥ËæπÊ°Ü
                    let b = border.vertical
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            let border = {}
                            if (y === colBegin + 1) {
                                border['right'] = b
                            } else if (y === colEnd + 1) {
                                border['left'] = b
                            } else {
                                border['left'] = b
                                border['right'] = b
                            }
                            let border1 = worksheet.getCell(i, y).border
                            worksheet.getCell(i, y).border = mergeCellBorder(border1, border)
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                } else if (border.none) {//ÂΩìluckysheetËæπÊ°Ü‰∏∫border-noneÁöÑÊó∂ÂÄôË°®Á§∫Ê≤°ÊúâËæπÊ°Ü ÂàôÂ∞ÜÂØπÂ∫îÁöÑÂçïÂÖÉÊ†ºborderÊ∏ÖÁ©∫
                    for (let i = row[0] + 1; i <= row[1] + 1; i++) {
                        for (let y = column[0] + 1; y <= column[1] + 1; y++) {
                            worksheet.getCell(i, y).border = {}
                            // console.log(i, y, worksheet.getCell(i, y).border)
                        }
                    }
                }
            }
            if (elem.rangeType === 'cell') {
                // col_index: 2
                // row_index: 1
                // b: {
                //   color: '#d0d4e3'
                //   style: 1
                // }
                const {col_index, row_index} = elem.value
                const borderData = Object.assign({}, elem.value)
                delete borderData.col_index
                delete borderData.row_index
                let border = addborderToCell(borderData, row_index, col_index)
                let border1 = worksheet.getCell(row_index + 1, col_index + 1).border;
                worksheet.getCell(row_index + 1, col_index + 1).border = mergeCellBorder(border1, border)
                // console.log(row_index + 1, col_index + 1, worksheet.getCell(row_index + 1, col_index + 1).border)
            }
        })
    }


    /**
     * ËÆæÁΩÆÂ∏¶Ê†∑ÂºèÁöÑÂÄº
     * @param cellArr
     * @param worksheet
     */
    var setStyleAndValue = function (cellArr, worksheet) {
        if (!Array.isArray(cellArr)) return
        cellArr.forEach(function (row, rowid) {
            row.every(function (cell, columnid) {
                if (!cell) return true
                let fill = fillConvert(cell.bg)

                let font = fontConvert(
                    cell.ff,
                    cell.fc,
                    cell.bl,
                    cell.it,
                    cell.fs,
                    cell.cl,
                    cell.un
                )
                let alignment = alignmentConvert(cell.vt, cell.ht, cell.tb, cell.tr)
                let value = ''

                if (cell.f) {
                    value = {formula: cell.f, result: cell.v}
                } else if (!cell.v && cell.ct && cell.ct.s) {
                    // xlsËΩ¨‰∏∫xlsx‰πãÂêéÔºåÂÜÖÈÉ®Â≠òÂú®‰∏çÂêåÁöÑÊ†ºÂºèÔºåÈÉΩ‰ºöËøõÂà∞ÂØåÊñáÊú¨ÈáåÔºåÂç≥ÂÄº‰∏çÂ≠òÂú®‰∏écell.vÔºåËÄåÊòØÂ≠òÂú®‰∫écell.ct.s‰πãÂêé
                    let richText = [];
                    let cts = cell.ct.s
                    for (let i = 0; i < cts.length; i++) {
                        let rt = {
                            text: cts[i].v,
                            font: fontConvert(cts[i].ff, cts[i].fc, cts[i].bl, cts[i].it, cts[i].fs, cts[i].cl, cts[i].un)
                        }
                        richText.push(rt)
                    }
                    value = {
                        richText: richText
                    };

                } else {
                    //ËÆæÁΩÆÂÄº‰∏∫Êï∞Â≠óÊ†ºÂºè
                    if (cell.v !== undefined && cell.v !== '') {
                        var v = +cell.v;
                        if (isNaN(v)) v = cell.v
                        value = v
                    }
                }
                //  style Â°´ÂÖ•Âà∞_value‰∏≠ÂèØ‰ª•ÂÆûÁé∞Â°´ÂÖÖËâ≤
                let letter = createCellPos(columnid)
                let target = worksheet.getCell(letter + (rowid + 1))
                // console.log('1233', letter + (rowid + 1))
                for (const key in fill) {
                    target.fill = fill
                    break
                }
                target.font = font
                target.alignment = alignment
                target.value = value

                try {
                    //ËÆæÁΩÆÂçïÂÖÉÊ†ºÊ†ºÂºè
                    target.numFmt = cell.ct.fa;
                } catch (e) {
                    console.warn(e)
                }

                return true
            })
        })
    }

    /**
     * ËÆæÁΩÆÂõæÁâá
     * @param images
     * @param worksheet
     * @param workbook
     */
    var setImages = function (images, worksheet, workbook) {
        if (typeof images != "object") return;
        for (let key in images) {
            // console.log(images[key]);
            // "data:image/png;base64,iVBORw0KG..."
            // ÈÄöËøá base64  Â∞ÜÂõæÂÉèÊ∑ªÂä†Âà∞Â∑•‰ΩúÁ∞ø
            const myBase64Image = images[key].src;
            //‰ΩçÁΩÆ
            const tl = {col: images[key].default.left / 72, row: images[key].default.top / 19}
            // Â§ßÂ∞è
            const ext = {width: images[key].default.width, height: images[key].default.height}
            const imageId = workbook.addImage({
                base64: myBase64Image,
                //extension: 'png',
            });
            worksheet.addImage(imageId, {
                tl: tl,
                ext: ext
            });
        }
    }

    /**
     * ÂÜªÁªìË°åÂàó
     * @param frozen
     * @param worksheet
     */
    var setFrozen = function (frozen = {}, worksheet) {
        switch (frozen.type) {
            // ÂÜªÁªìÈ¶ñË°å
            case 'row': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 0, ySplit: 1}
                ];
                break
            }
            // ÂÜªÁªìÈ¶ñÂàó
            case 'column': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 1, ySplit: 0}
                ];
                break
            }
            // ÂÜªÁªìË°åÂàó
            case 'both': {
                worksheet.views = [
                    {state: 'frozen', xSplit: 1, ySplit: 1}
                ];
                break
            }
            // ÂÜªÁªìË°åÂà∞ÈÄâÂå∫
            case 'rangeRow': {
                let row = frozen.range.row_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: 0, ySplit: row}
                ];
                break
            }
            // ÂÜªÁªìÂàóÂà∞ÈÄâÂå∫
            case 'rangeColumn': {
                let column = frozen.range.column_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: column, ySplit: 0}
                ];
                break
            }
            // ÂÜªÁªìË°åÂàóÂà∞ÈÄâÂå∫
            case 'rangeBoth': {
                let row = frozen.range.row_focus + 1
                let column = frozen.range.column_focus + 1
                worksheet.views = [
                    {state: 'frozen', xSplit: column, ySplit: row}
                ];
            }

        }

    }

    /**
     * Ë°åÈöêËóè
     * @param rowhidden
     * @param worksheet
     */
    var setRowHidden = function (rowhidden = {}, worksheet) {
        for (const key in rowhidden) {
            //Â¶ÇÊûúÂΩìÂâçË°åÊ≤°ÊúâÂÜÖÂÆπÂàôÈöêËóè‰∏çÁîüÊïà
            const row = worksheet.getRow(parseInt(key) + 1)
            row.hidden = true;
        }
    }

    /**
     * ÂàóÈöêËóè
     * @param colhidden
     * @param worksheet
     */
    var setColHidden = function (colhidden = {}, worksheet) {
        for (const key in colhidden) {
            const column = worksheet.getColumn(parseInt(key) + 1)
            column.hidden = true;
        }
    }

    /**
     * Ëá™Âä®Á≠õÈÄâÂô®
     * @param filter
     * @param worksheet
     */
    var setFilter = function (filter = {}, worksheet) {
        if (Object.keys(filter).length === 0) return
        const from = {
            row: filter.row[0] + 1,
            column: filter.column[0] + 1
        }

        const to = {
            row: filter.row[1] + 1,
            column: filter.column[1] + 1
        }

        worksheet.autoFilter = {
            from: from,
            to: to
        }

    }

    var fillConvert = function (bg) {
        if (!bg) {
            return {}
        }
        // const bgc = bg.replace('#', '')
        let fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: {argb: bg.startsWith("#") ? bg.replace('#', '') : colorRGBtoHex(bg).replace("#", "")},
        }
        return fill;
    }

    var fontConvert = function (
        ff = 0,
        fc = '#000000',
        bl = 0,
        it = 0,
        fs = 10,
        cl = 0,
        ul = 0
    ) {
        // luckysheetÔºöff(Ê†∑Âºè), fc(È¢úËâ≤), bl(Á≤ó‰Ωì), it(Êñú‰Ωì), fs(Â§ßÂ∞è), cl(Âà†Èô§Á∫ø), ul(‰∏ãÂàíÁ∫ø)
        const luckyToExcel = {
            0: 'ÂæÆËΩØÈõÖÈªë',
            1: 'ÂÆã‰ΩìÔºàSongÔºâ',
            2: 'Èªë‰ΩìÔºàST HeitiÔºâ',
            3: 'Ê•∑‰ΩìÔºàST KaitiÔºâ',
            4: '‰ªøÂÆãÔºàST FangSongÔºâ',
            5: 'Êñ∞ÂÆã‰ΩìÔºàST SongÔºâ',
            6: 'ÂçéÊñáÊñ∞È≠è',
            7: 'ÂçéÊñáË°åÊ•∑',
            8: 'ÂçéÊñáÈö∂‰π¶',
            9: 'Arial',
            10: 'Times New Roman ',
            11: 'Tahoma ',
            12: 'Verdana',
            num2bl: function (num) {
                return num !== 0
            }
        }
        // Âá∫Áé∞BugÔºåÂØºÂÖ•ÁöÑÊó∂ÂÄôff‰∏∫luckyToExcelÁöÑval

        let font = {
            name: typeof ff === 'number' ? luckyToExcel[ff] : ff,
            family: 1,
            size: fs,
            color: {argb: fc.startsWith("#") ? fc.replace('#', '') : colorRGBtoHex(fc).replace("#", "")},
            bold: luckyToExcel.num2bl(bl),
            italic: luckyToExcel.num2bl(it),
            underline: luckyToExcel.num2bl(ul),
            strike: luckyToExcel.num2bl(cl)
        }

        return font
    }

    var alignmentConvert = function (
        vt = 'default',
        ht = 'default',
        tb = 'default',
        tr = 'default'
    ) {
        // luckysheet:vt(ÂûÇÁõ¥), ht(Ê∞¥Âπ≥), tb(Êç¢Ë°å), tr(ÊóãËΩ¨)
        const luckyToExcel = {
            vertical: {
                0: 'middle',
                1: 'top',
                2: 'bottom',
                default: 'middle'
            },
            horizontal: {
                0: 'center',
                1: 'left',
                2: 'right',
                default: 'center'
            },
            wrapText: {
                0: false,
                1: false,
                2: true,
                default: false
            },
            textRotation: {
                0: 0,
                1: 45,
                2: -45,
                3: 'vertical',
                4: 90,
                5: -90,
                default: 0
            }
        }

        let alignment = {
            vertical: luckyToExcel.vertical[vt],
            horizontal: luckyToExcel.horizontal[ht],
            wrapText: luckyToExcel.wrapText[tb],
            textRotation: luckyToExcel.textRotation[tr]
        }
        return alignment
    }

    var borderConvert = function (borderType, style = 1, color = '#000') {
        // ÂØπÂ∫îluckysheetÁöÑconfig‰∏≠borderinfoÁöÑÁöÑÂèÇÊï∞
        if (!borderType) {
            return {}
        }
        const luckyToExcel = {
            type: {
                'border-all': 'all',
                'border-top': 'top',
                'border-right': 'right',
                'border-bottom': 'bottom',
                'border-left': 'left',
                'border-outside': 'outside',
                'border-inside': 'inside',
                'border-horizontal': 'horizontal',
                'border-vertical': 'vertical',
                'border-none': 'none',
            },
            style: {
                0: 'none',
                1: 'thin',
                2: 'hair',
                3: 'dotted',
                4: 'dashDot', // 'Dashed',
                5: 'dashDot',
                6: 'dashDotDot',
                7: 'double',
                8: 'medium',
                9: 'mediumDashed',
                10: 'mediumDashDot',
                11: 'mediumDashDotDot',
                12: 'slantDashDot',
                13: 'thick'
            }
        }
        let border = {}
        border[luckyToExcel.type[borderType]] = {
            style: luckyToExcel.style[style],
            color: {argb: color.replace('#', '')}
        }
        return border
    }

    function addborderToCell(borders, row_index, col_index) {
        let border = {}
        const luckyExcel = {
            type: {
                l: 'left',
                r: 'right',
                b: 'bottom',
                t: 'top'
            },
            style: {
                0: 'none',
                1: 'thin',
                2: 'hair',
                3: 'dotted',
                4: 'dashDot', // 'Dashed',
                5: 'dashDot',
                6: 'dashDotDot',
                7: 'double',
                8: 'medium',
                9: 'mediumDashed',
                10: 'mediumDashDot',
                11: 'mediumDashDotDot',
                12: 'slantDashDot',
                13: 'thick'
            }
        }
        // console.log('borders', borders)
        for (const bor in borders) {
            // console.log(bor)
            if (borders[bor].color.indexOf('rgb') === -1) {
                border[luckyExcel.type[bor]] = {
                    style: luckyExcel.style[borders[bor].style],
                    color: {argb: borders[bor].color.replace('#', '')}
                }
            } else {
                border[luckyExcel.type[bor]] = {
                    style: luckyExcel.style[borders[bor].style],
                    color: {argb: borders[bor].color}
                }
            }
        }

        return border
    }

    function createCellPos(n) {
        let ordA = 'A'.charCodeAt(0)

        let ordZ = 'Z'.charCodeAt(0)
        let len = ordZ - ordA + 1
        let s = ''
        while (n >= 0) {
            s = String.fromCharCode((n % len) + ordA) + s

            n = Math.floor(n / len) - 1
        }
        return s
    }

    //rgb(255,255,255)ËΩ¨16ËøõÂà∂ #ffffff
    function colorRGBtoHex(color) {
        color = color.replace("rgb", "").replace("(", "").replace(")", "")
        var rgb = color.split(',');
        var r = parseInt(rgb[0]);
        var g = parseInt(rgb[1]);
        var b = parseInt(rgb[2]);
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
</script>
</body>

</html>