<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>è¯´è¯</title>
    <link rel="stylesheet" href="talk.css"/>
</head>

<body>
<div style="width: 700px;margin: 0 auto;">
    <div id="chatroom"></div>

    <form id="talk-form" action="talk.php" target="talkFrame">
        <div>
            <textarea name="talk" id="input" rows="4" cols="80" accesskey="Z"></textarea>
        </div>
        <input type="submit">
        <input type="reset">
        <input type="button" value="æ¸…å±" onclick="$('chatroom').innerHTML=''">
        <span id="toggle_speech" style="cursor:pointer">ğŸ•ª</span>
        <select id="voi"></select>
        <label class="pick">
            <input type="checkbox" id="toggle_recognize" title="è¯´è¯å¼€å…³"
                   onclick="this.checked?recognition.start():recognition.stop()" checked/>
            <span>ğŸ™ï¸</span>
        </label>
    </form>
    <iframe name="talkFrame" id="talkFrame" width=100% height="420" src="about:blank"
            style="border: 1px solid #bfbfbf;"></iframe>
</div>
</body>
<script src="../lib/tts.js"></script>
<script src="open-web.js"></script>
<script>
    function $(str) {
        return document.getElementById(str);
    }

    var input = $('input');
    var chatroom = $('chatroom');
    var nick = 'cqiu'; //prompt("enter your name");
    var toggle_speech = $('toggle_speech');
    var toggle_recognize = $('toggle_recognize');
    let voiceSelect = $('voi');

    var rate = 1.3,
        vi = 7;

    function string2Color(str) {
        var hash = 0;
        for (var i = 0, n = Math.min(str.length, 16); i < n; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }

        var color = "#";
        for (var j = 0; j < 3; j++) {
            var value = (hash >> (j * 8)) & 0xFF;
            color += ("00" + value.toString(16)).substr(-2);
        }

        return color;
    }

    let initTry = 0;

    // tts callback
    function initVoices() {
        /*if (voices.length === 0) {
            if (initTry++ > 3) {
                console.error('initVoices failed');
                return;
            }
            setTimeout(initVoices, 100);
        }*/
        voiceSelect.innerHTML = "";
        voiceSelect.onchange = function () {
            this.style.backgroundColor = voiceSelect.options[voiceSelect.selectedIndex].style.backgroundColor;
        };
        for (let i = 0; i < voices.length; i++) {
            let tmp = voices[i].name.replace(/(Microsoft | Online \(Natural\)|Chinese )/g, '');
            const option = document.createElement("option");
            option.textContent = tmp;
            option.style.backgroundColor = string2Color(tmp);
            voiceSelect.appendChild(option);
        }
        voiceSelect.selectedIndex = vi;
        voiceSelect.onchange();//dispatchEvent(new Event("change"));
    }

    window.onload = function () {
        $('input').focus();

        toggle_speech.onclick = function () {
            if (this.innerText === 'ğŸ•¨') {
                this.innerText = 'ğŸ•ª';
            } else {
                this.innerText = 'ğŸ•¨';
                speechSynthesis.cancel();
            }
        };

        startRecognition();
    };

    // -----------------------
    let recognition;

    // å¼€å§‹è¯­éŸ³è¯†åˆ«
    function startRecognition() {
        recognition = new webkitSpeechRecognition() || new SpeechRecognition();

        recognition.lang = 'zh-CN';
        recognition.interimResults = true;
        // recognition.continuous = true;

        // å½“è¯†åˆ«åˆ°è¯­éŸ³æ—¶è§¦å‘è¯¥äº‹ä»¶
        recognition.onresult = function (event) {
            input.value = event.results[0][0].transcript;
        }

        recognition.startOn = () => {
            if (!toggle_recognize.checked) return;
            console.log('start recognition');
            // console.log(recognition.status); // recognition.status === "inactive" &&
            recognition.start();
        };

        // å¯åŠ¨è¯­éŸ³è¯†åˆ«
        recognition.startOn();

        recognition.addEventListener('end', () => {
            console.log('end recognition');
            if (!input.value) recognition.startOn();
            else form.onsubmit() && form.submit();
        });
    }

    var callback = () => recognition.startOn();

    // -----------------------
    function renderChat(who, msg) {
        var div = document.createElement("div");
        div.className = 'chat';
        if (who === nick) div.className += ' i-say';
        div.innerHTML = ('<u class="q-' + who + '">' + who + '</u>' + msg); //.trim();
        chatroom.append(div);
        chatroom.scrollTop = chatroom.scrollHeight;
        // input.scrollIntoView();
    }


    function strip(html) {
        let doc = new DOMParser().parseFromString(html, 'text/html');
        return doc.body.textContent || "";
    }

    function read(sentence) {
        if (toggle_speech.innerText !== 'ğŸ•ª') {
            callback();
            return;
        }

        if (!sentence) return;
        console.log(sentence);

        speechSynthesis.cancel();
        sentence = strip(sentence.replace(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/, ''));
        speak({text: sentence, voice: voiceSelect.selectedIndex, rate, end: callback});
    }

    function response(who, msg) {
        renderChat(who, msg.replace(/\n/g, '<br>').replace('  ', '&nbsp;&nbsp'));
        read(msg);
        input.value = '';
    }

    var form = $('talk-form');
    form.onsubmit = function () {
        var msg = input.value;
        if (!msg.trim()) {
            callback();
            return false;
        }
        // åªæœ‰ç®€å•è¯­æ°”è¯è¯´æ˜å¹¶ä¸æ˜¯åœ¨å¯¹æˆ‘è¯´è¯ï¼Œæš‚åœå§
        if (/^[å—¯å“¦å•Šå‘¢ï¼Œã€ã€‚ï¼Ÿ]+$/.test(msg)) {
            input.value = '';
            return false;
        }
        renderChat(nick, msg);
        // æ‰“å¼€ç½‘é¡µåæš‚ä¸å¼€å¯è¯­éŸ³è¯†åˆ«
        if (openWeb(msg)) {
            input.value = '';
            return false;
        }
        return true;
    };

    document.onkeydown = function (e) {
        if (e.key === 'Escape') {
            console.log('reset start!')
            speechSynthesis.cancel();
            recognition.startOn();

            $('talk-form').reset();
            return false;
        }
    };
</script>

</html>